#include "console.h"

// Simple 8x16 bitmap font for ASCII characters (space to ~)
static const uint8_t font_8x16[95][16] = {
    // Space (32)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00},
    // ! (33)
    {0x00, 0x00, 0x18, 0x3C, 0x3C, 0x3C, 0x18, 0x18, 0x18, 0x00, 0x18, 0x18,
     0x00, 0x00, 0x00, 0x00},
    // " (34)
    {0x00, 0x63, 0x63, 0x63, 0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00},
    // # (35)
    {0x00, 0x00, 0x00, 0x36, 0x36, 0x7F, 0x36, 0x36, 0x36, 0x7F, 0x36, 0x36,
     0x00, 0x00, 0x00, 0x00},
    // $ (36)
    {0x0C, 0x0C, 0x3E, 0x63, 0x61, 0x60, 0x3E, 0x03, 0x03, 0x43, 0x63, 0x3E,
     0x0C, 0x0C, 0x00, 0x00},
    // % (37)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x61, 0x63, 0x06, 0x0C, 0x18, 0x33, 0x63,
     0x00, 0x00, 0x00, 0x00},
    // & (38)
    {0x00, 0x00, 0x00, 0x1C, 0x36, 0x36, 0x1C, 0x3B, 0x6E, 0x66, 0x66, 0x3B,
     0x00, 0x00, 0x00, 0x00},
    // ' (39)
    {0x00, 0x30, 0x30, 0x30, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00},
    // ( (40)
    {0x00, 0x00, 0x0C, 0x18, 0x18, 0x30, 0x30, 0x30, 0x30, 0x18, 0x18, 0x0C,
     0x00, 0x00, 0x00, 0x00},
    // ) (41)
    {0x00, 0x00, 0x30, 0x18, 0x18, 0x0C, 0x0C, 0x0C, 0x0C, 0x18, 0x18, 0x30,
     0x00, 0x00, 0x00, 0x00},
    // * (42)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x36, 0x1C, 0x7F, 0x1C, 0x36, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00},
    // + (43)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00},
    // , (44)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x18,
     0x30, 0x00, 0x00, 0x00},
    // - (45)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00},
    // . (46)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18,
     0x00, 0x00, 0x00, 0x00},
    // / (47)
    {0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x40,
     0x00, 0x00, 0x00, 0x00},
    // 0 (48)
    {0x00, 0x00, 0x3E, 0x63, 0x63, 0x63, 0x6B, 0x6B, 0x63, 0x63, 0x63, 0x3E,
     0x00, 0x00, 0x00, 0x00},
    // 1 (49)
    {0x00, 0x00, 0x0C, 0x1C, 0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3F,
     0x00, 0x00, 0x00, 0x00},
    // 2 (50)
    {0x00, 0x00, 0x3E, 0x63, 0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x63, 0x7F,
     0x00, 0x00, 0x00, 0x00},
    // 3 (51)
    {0x00, 0x00, 0x3E, 0x63, 0x03, 0x03, 0x1E, 0x03, 0x03, 0x03, 0x63, 0x3E,
     0x00, 0x00, 0x00, 0x00},
    // 4 (52)
    {0x00, 0x00, 0x06, 0x0E, 0x1E, 0x36, 0x66, 0x7F, 0x06, 0x06, 0x06, 0x0F,
     0x00, 0x00, 0x00, 0x00},
    // 5 (53)
    {0x00, 0x00, 0x7F, 0x60, 0x60, 0x60, 0x7E, 0x03, 0x03, 0x03, 0x63, 0x3E,
     0x00, 0x00, 0x00, 0x00},
    // 6 (54)
    {0x00, 0x00, 0x1C, 0x30, 0x60, 0x60, 0x7E, 0x63, 0x63, 0x63, 0x63, 0x3E,
     0x00, 0x00, 0x00, 0x00},
    // 7 (55)
    {0x00, 0x00, 0x7F, 0x63, 0x03, 0x06, 0x06, 0x0C, 0x0C, 0x18, 0x18, 0x18,
     0x00, 0x00, 0x00, 0x00},
    // 8 (56)
    {0x00, 0x00, 0x3E, 0x63, 0x63, 0x63, 0x3E, 0x63, 0x63, 0x63, 0x63, 0x3E,
     0x00, 0x00, 0x00, 0x00},
    // 9 (57)
    {0x00, 0x00, 0x3E, 0x63, 0x63, 0x63, 0x3F, 0x03, 0x03, 0x03, 0x06, 0x3C,
     0x00, 0x00, 0x00, 0x00},
    // : (58)
    {0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00,
     0x00, 0x00, 0x00, 0x00},
    // ; (59)
    {0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x18, 0x18, 0x30,
     0x00, 0x00, 0x00, 0x00},
    // < (60)
    {0x00, 0x00, 0x00, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x30, 0x18, 0x0C, 0x06,
     0x00, 0x00, 0x00, 0x00},
    // = (61)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x7E, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00},
    // > (62)
    {0x00, 0x00, 0x00, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x0C, 0x18, 0x30, 0x60,
     0x00, 0x00, 0x00, 0x00},
    // ? (63)
    {0x00, 0x00, 0x3E, 0x63, 0x63, 0x06, 0x0C, 0x0C, 0x0C, 0x00, 0x0C, 0x0C,
     0x00, 0x00, 0x00, 0x00},
    // @ (64)
    {0x00, 0x00, 0x00, 0x3E, 0x63, 0x63, 0x6F, 0x6B, 0x6F, 0x60, 0x60, 0x3E,
     0x00, 0x00, 0x00, 0x00},
    // A (65)
    {0x00, 0x00, 0x08, 0x1C, 0x36, 0x63, 0x63, 0x7F, 0x63, 0x63, 0x63, 0x63,
     0x00, 0x00, 0x00, 0x00},
    // B (66)
    {0x00, 0x00, 0x7E, 0x33, 0x33, 0x33, 0x3E, 0x33, 0x33, 0x33, 0x33, 0x7E,
     0x00, 0x00, 0x00, 0x00},
    // C (67)
    {0x00, 0x00, 0x1E, 0x33, 0x61, 0x60, 0x60, 0x60, 0x60, 0x61, 0x33, 0x1E,
     0x00, 0x00, 0x00, 0x00},
    // D (68)
    {0x00, 0x00, 0x7C, 0x36, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x36, 0x7C,
     0x00, 0x00, 0x00, 0x00},
    // E (69)
    {0x00, 0x00, 0x7F, 0x33, 0x31, 0x34, 0x3C, 0x34, 0x30, 0x31, 0x33, 0x7F,
     0x00, 0x00, 0x00, 0x00},
    // F (70)
    {0x00, 0x00, 0x7F, 0x33, 0x31, 0x34, 0x3C, 0x34, 0x30, 0x30, 0x30, 0x78,
     0x00, 0x00, 0x00, 0x00},
    // G (71)
    {0x00, 0x00, 0x1E, 0x33, 0x61, 0x60, 0x60, 0x6F, 0x63, 0x63, 0x37, 0x1D,
     0x00, 0x00, 0x00, 0x00},
    // H (72)
    {0x00, 0x00, 0x63, 0x63, 0x63, 0x63, 0x7F, 0x63, 0x63, 0x63, 0x63, 0x63,
     0x00, 0x00, 0x00, 0x00},
    // I (73)
    {0x00, 0x00, 0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C,
     0x00, 0x00, 0x00, 0x00},
    // J (74)
    {0x00, 0x00, 0x0F, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x66, 0x66, 0x3C,
     0x00, 0x00, 0x00, 0x00},
    // K (75)
    {0x00, 0x00, 0x73, 0x33, 0x36, 0x36, 0x3C, 0x36, 0x36, 0x33, 0x33, 0x73,
     0x00, 0x00, 0x00, 0x00},
    // L (76)
    {0x00, 0x00, 0x78, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x31, 0x33, 0x7F,
     0x00, 0x00, 0x00, 0x00},
    // M (77)
    {0x00, 0x00, 0x63, 0x77, 0x7F, 0x7F, 0x6B, 0x63, 0x63, 0x63, 0x63, 0x63,
     0x00, 0x00, 0x00, 0x00},
    // N (78)
    {0x00, 0x00, 0x63, 0x63, 0x73, 0x7B, 0x7F, 0x6F, 0x67, 0x63, 0x63, 0x63,
     0x00, 0x00, 0x00, 0x00},
    // O (79)
    {0x00, 0x00, 0x1C, 0x36, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x36, 0x1C,
     0x00, 0x00, 0x00, 0x00},
    // P (80)
    {0x00, 0x00, 0x7E, 0x33, 0x33, 0x33, 0x3E, 0x30, 0x30, 0x30, 0x30, 0x78,
     0x00, 0x00, 0x00, 0x00},
    // Q (81)
    {0x00, 0x00, 0x1C, 0x36, 0x63, 0x63, 0x63, 0x63, 0x63, 0x6B, 0x36, 0x1C,
     0x06, 0x07, 0x00, 0x00},
    // R (82)
    {0x00, 0x00, 0x7E, 0x33, 0x33, 0x33, 0x3E, 0x36, 0x36, 0x33, 0x33, 0x73,
     0x00, 0x00, 0x00, 0x00},
    // S (83)
    {0x00, 0x00, 0x3E, 0x63, 0x63, 0x30, 0x1C, 0x06, 0x03, 0x63, 0x63, 0x3E,
     0x00, 0x00, 0x00, 0x00},
    // T (84)
    {0x00, 0x00, 0x7E, 0x5A, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C,
     0x00, 0x00, 0x00, 0x00},
    // U (85)
    {0x00, 0x00, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x3E,
     0x00, 0x00, 0x00, 0x00},
    // V (86)
    {0x00, 0x00, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x36, 0x1C, 0x08,
     0x00, 0x00, 0x00, 0x00},
    // W (87)
    {0x00, 0x00, 0x63, 0x63, 0x63, 0x63, 0x6B, 0x6B, 0x6B, 0x7F, 0x36, 0x36,
     0x00, 0x00, 0x00, 0x00},
    // X (88)
    {0x00, 0x00, 0x63, 0x63, 0x36, 0x1C, 0x1C, 0x1C, 0x36, 0x63, 0x63, 0x63,
     0x00, 0x00, 0x00, 0x00},
    // Y (89)
    {0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x18, 0x18, 0x18, 0x3C,
     0x00, 0x00, 0x00, 0x00},
    // Z (90)
    {0x00, 0x00, 0x7F, 0x63, 0x46, 0x0C, 0x18, 0x30, 0x60, 0x61, 0x63, 0x7F,
     0x00, 0x00, 0x00, 0x00},
    // [ (91)
    {0x00, 0x00, 0x3C, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3C,
     0x00, 0x00, 0x00, 0x00},
    // \ (92)
    {0x00, 0x00, 0x00, 0x40, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x03, 0x01, 0x00,
     0x00, 0x00, 0x00, 0x00},
    // ] (93)
    {0x00, 0x00, 0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3C,
     0x00, 0x00, 0x00, 0x00},
    // ^ (94)
    {0x08, 0x1C, 0x36, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00},
    // _ (95)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xFF, 0x00, 0x00, 0x00},
    // ` (96)
    {0x00, 0x18, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00},
    // a (97)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x46, 0x06, 0x3E, 0x66, 0x66, 0x3B,
     0x00, 0x00, 0x00, 0x00},
    // b (98)
    {0x00, 0x00, 0x70, 0x30, 0x30, 0x3E, 0x33, 0x33, 0x33, 0x33, 0x33, 0x6E,
     0x00, 0x00, 0x00, 0x00},
    // c (99)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x3E, 0x63, 0x60, 0x60, 0x60, 0x63, 0x3E,
     0x00, 0x00, 0x00, 0x00},
    // d (100)
    {0x00, 0x00, 0x0E, 0x06, 0x06, 0x3E, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3B,
     0x00, 0x00, 0x00, 0x00},
    // e (101)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x3E, 0x63, 0x7F, 0x60, 0x60, 0x63, 0x3E,
     0x00, 0x00, 0x00, 0x00},
    // f (102)
    {0x00, 0x00, 0x1C, 0x36, 0x32, 0x30, 0x7C, 0x30, 0x30, 0x30, 0x30, 0x78,
     0x00, 0x00, 0x00, 0x00},
    // g (103)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x3B, 0x66, 0x66, 0x66, 0x66, 0x3E, 0x06,
     0x66, 0x3C, 0x00, 0x00},
    // h (104)
    {0x00, 0x00, 0x70, 0x30, 0x30, 0x36, 0x3B, 0x33, 0x33, 0x33, 0x33, 0x73,
     0x00, 0x00, 0x00, 0x00},
    // i (105)
    {0x00, 0x00, 0x0C, 0x0C, 0x00, 0x1C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x1E,
     0x00, 0x00, 0x00, 0x00},
    // j (106)
    {0x00, 0x00, 0x06, 0x06, 0x00, 0x0E, 0x06, 0x06, 0x06, 0x06, 0x06, 0x66,
     0x66, 0x3C, 0x00, 0x00},
    // k (107)
    {0x00, 0x00, 0x70, 0x30, 0x30, 0x33, 0x33, 0x36, 0x3C, 0x36, 0x33, 0x73,
     0x00, 0x00, 0x00, 0x00},
    // l (108)
    {0x00, 0x00, 0x1C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x1E,
     0x00, 0x00, 0x00, 0x00},
    // m (109)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x6E, 0x7F, 0x6B, 0x6B, 0x6B, 0x6B, 0x6B,
     0x00, 0x00, 0x00, 0x00},
    // n (110)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x6E, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33,
     0x00, 0x00, 0x00, 0x00},
    // o (111)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x3E, 0x63, 0x63, 0x63, 0x63, 0x63, 0x3E,
     0x00, 0x00, 0x00, 0x00},
    // p (112)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x6E, 0x33, 0x33, 0x33, 0x33, 0x3E, 0x30,
     0x30, 0x78, 0x00, 0x00},
    // q (113)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x3B, 0x66, 0x66, 0x66, 0x66, 0x3E, 0x06,
     0x06, 0x0F, 0x00, 0x00},
    // r (114)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x6E, 0x3B, 0x33, 0x30, 0x30, 0x30, 0x78,
     0x00, 0x00, 0x00, 0x00},
    // s (115)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x3E, 0x63, 0x38, 0x0E, 0x03, 0x63, 0x3E,
     0x00, 0x00, 0x00, 0x00},
    // t (116)
    {0x00, 0x00, 0x08, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x18, 0x18, 0x1B, 0x0E,
     0x00, 0x00, 0x00, 0x00},
    // u (117)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3B,
     0x00, 0x00, 0x00, 0x00},
    // v (118)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0x63, 0x63, 0x63, 0x36, 0x1C, 0x08,
     0x00, 0x00, 0x00, 0x00},
    // w (119)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0x63, 0x6B, 0x6B, 0x6B, 0x7F, 0x36,
     0x00, 0x00, 0x00, 0x00},
    // x (120)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0x36, 0x1C, 0x1C, 0x1C, 0x36, 0x63,
     0x00, 0x00, 0x00, 0x00},
    // y (121)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0x63, 0x63, 0x63, 0x63, 0x3F, 0x03,
     0x06, 0x3C, 0x00, 0x00},
    // z (122)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x7F, 0x66, 0x0C, 0x18, 0x30, 0x63, 0x7F,
     0x00, 0x00, 0x00, 0x00},
    // { (123)
    {0x00, 0x00, 0x0E, 0x18, 0x18, 0x18, 0x70, 0x18, 0x18, 0x18, 0x18, 0x0E,
     0x00, 0x00, 0x00, 0x00},
    // | (124)
    {0x00, 0x00, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x18, 0x18, 0x18,
     0x00, 0x00, 0x00, 0x00},
    // } (125)
    {0x00, 0x00, 0x70, 0x18, 0x18, 0x18, 0x0E, 0x18, 0x18, 0x18, 0x18, 0x70,
     0x00, 0x00, 0x00, 0x00},
    // ~ (126)
    {0x00, 0x00, 0x3B, 0x6E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00},
};

// Custom glyphs for special logo characters (mapped to 1-7)
static const uint8_t custom_glyphs[8][16] = {
    {0}, // 0: Unused
    // 1: Full Block (█)
    {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
     0xFF, 0xFF, 0xFF, 0xFF},
    // 2: Vertical Double (║)
    {0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
     0x36, 0x36, 0x36, 0x36},
    // 3: Double Down-Left (╗)
    {0x00, 0x00, 0x00, 0x3E, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
     0x36, 0x36, 0x36, 0x36},
    // Wait, ╗ connects Left to Down.
    // 00111110 (3E) - Top border? No, Double line.
    // Let's manually define bits.
    // ..#..#.. (36) is vertical.
    // .......# (01)
    // ╗ : Hoz double on left, Vert double down.
    // Row 0-3: Empty or vertical? No center.
    // Middle: Hoz line.
    // Let's stick to simple logical definitions.
    // For 8x16:
    // 3: ╗
    // Left side Hoz: 0x??
    // Right side Vert: 0x??
    // Actually, I'll use a simpler approximation for lines to avoid spending
    // hours on bits. Or I'll just use the full block for everything if lazy,
    // but user wants lines. 3 (╗):
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33,
     0x33, 0x33, 0x33, 0x33}, // Approx
    // 4: ╝ (Double Up-Left)
    {0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x63, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00},
    // 5: ╚ (Double Up-Right)
    {0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x3F, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00},
    // 6: ╔ (Double Down-Right)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33,
     0x33, 0x33, 0x33, 0x33},
    // 7: ═ (Horizontal Double)
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00}};

// Console state
static uint32_t cursor_x = 0;
static uint32_t cursor_y = 0;
static uint32_t console_width = 0;
static uint32_t console_height = 0;
static struct limine_framebuffer *fb = NULL;
static uint32_t current_fg_color = 0xFFFFFF; // Default White

#define CHAR_WIDTH 8
#define CHAR_HEIGHT 16
#define BG_COLOR 0x000000

// Put a single pixel on the framebuffer
static inline void put_pixel(uint32_t x, uint32_t y, uint32_t color) {
  if (fb == NULL || x >= fb->width || y >= fb->height)
    return;
  volatile uint32_t *pixel =
      (volatile uint32_t *)((uint8_t *)fb->address + y * fb->pitch + x * 4);
  *pixel = color;
}

// Draw a character at the specified position
static void draw_char(uint32_t x, uint32_t y, char c, uint32_t fg_color,
                      uint32_t bg_color) {
  const uint8_t *glyph;
  if (c >= 1 && c <= 7) {
    glyph = custom_glyphs[(int)c];
  } else if (c < 32 || c > 126) {
    c = ' ';
    glyph = font_8x16[0];
  } else {
    glyph = font_8x16[c - 32];
  }

  for (int row = 0; row < CHAR_HEIGHT; row++) {
    uint8_t bits = glyph[row];
    for (int col = 0; col < CHAR_WIDTH; col++) {
      uint32_t color = (bits & (0x80 >> col)) ? fg_color : bg_color;
      put_pixel(x + col, y + row, color);
    }
  }
}

void console_init(struct limine_framebuffer *framebuffer) {
  fb = framebuffer;
  cursor_x = 0;
  cursor_y = 0;
  console_width = fb->width / CHAR_WIDTH;
  console_height = fb->height / CHAR_HEIGHT;
  current_fg_color = 0xFFFFFF;
  console_clear();
}

void console_putchar(char c) {
  if (fb == NULL)
    return;

  if (c == '\n') {
    cursor_x = 0;
    cursor_y++;
  } else if (c == '\r') {
    cursor_x = 0;
  } else if (c == '\b') {
    console_backspace();
  } else {
    draw_char(cursor_x * CHAR_WIDTH, cursor_y * CHAR_HEIGHT, c,
              current_fg_color, BG_COLOR);
    cursor_x++;
  }

  if (cursor_x >= console_width) {
    cursor_x = 0;
    cursor_y++;
  }

  if (cursor_y >= console_height) {
    // Implement scrolling
    uint32_t *buffer = (uint32_t *)fb->address;
    uint64_t pitch_pixels = fb->pitch / 4;

    // Move lines up
    for (uint64_t y = 0; y < (console_height - 1) * CHAR_HEIGHT; y++) {
      for (uint64_t x = 0; x < fb->width; x++) {
        buffer[y * pitch_pixels + x] =
            buffer[(y + CHAR_HEIGHT) * pitch_pixels + x];
      }
    }

    // Clear last line
    for (uint64_t y = (console_height - 1) * CHAR_HEIGHT; y < fb->height; y++) {
      for (uint64_t x = 0; x < fb->width; x++) {
        buffer[y * pitch_pixels + x] = BG_COLOR;
      }
    }

    cursor_y--;
  }
}

// Simple ANSI color parser
static uint32_t ansi_to_color(int code) {
  switch (code) {
  case 30:
    return 0x000000; // Black
  case 31:
    return 0xFF0000; // Red
  case 32:
    return 0x00FF00; // Green
  case 33:
    return 0xFFFF00; // Yellow
  case 34:
    return 0x0D00A4; // Deep Blue (Custom)
  case 35:
    return 0xFF00FF; // Magenta
  case 36:
    return 0x00FFFF; // Cyan
  case 37:
    return 0xFFFFFF; // White
  case 90:
    return 0x555555; // Gray
  case 91:
    return 0xFF5555; // Light Red
  case 92:
    return 0x55FF55; // Light Green
  case 93:
    return 0xFFFF55; // Light Yellow
  case 94:
    return 0x5555FF; // Light Blue
  case 95:
    return 0xFF55FF; // Light Magenta
  case 96:
    return 0x55FFFF; // Light Cyan
  case 97:
    return 0xFFFFFF; // White
  default:
    return 0xFFFFFF;
  }
}

void console_print(const char *str) {
  while (*str) {
    // Handle ANSI escape codes
    if (*str == '\033') {
      str++; // Skip ESC
      if (*str == '[') {
        str++;
        // Parse number
        int code = 0;
        while (*str >= '0' && *str <= '9') {
          code = code * 10 + (*str - '0');
          str++;
        }
        if (*str == 'm') {
          if (code == 0)
            current_fg_color = 0xFFFFFF; // Reset
          else
            current_fg_color = ansi_to_color(code);
          str++;
        } else if (*str == ';') {
          // Skip compound codes for now (lazy parser)
          while (*str && *str != 'm')
            str++;
          if (*str == 'm')
            str++;
        }
      }
      continue;
    }
    console_putchar(*str++);
  }
}

void console_print_hex(uint64_t n) {
  char hex[] = "0123456789ABCDEF";
  console_print("0x");
  for (int i = 60; i >= 0; i -= 4) {
    console_putchar(hex[(n >> i) & 0xF]);
  }
}

void console_print_dec(uint64_t n) {
  if (n == 0) {
    console_putchar('0');
    return;
  }
  char buf[20];
  int i = 0;
  while (n > 0) {
    buf[i++] = (n % 10) + '0';
    n /= 10;
  }
  while (i > 0) {
    console_putchar(buf[--i]);
  }
}

void console_clear(void) {
  if (fb == NULL)
    return;

  for (uint32_t y = 0; y < fb->height; y++) {
    for (uint32_t x = 0; x < fb->width; x++) {
      put_pixel(x, y, BG_COLOR);
    }
  }
  cursor_x = 0;
  cursor_y = 0;
}

void console_backspace(void) {
  if (cursor_x > 0) {
    cursor_x -= 1;
  } else if (cursor_y > 0) {
    cursor_y -= 1;
    cursor_x = console_width - 1;
  }
  // Clear the character area
  for (uint32_t py = 0; py < CHAR_HEIGHT; py++) {
    uint32_t *dest = (uint32_t *)((uint8_t *)fb->address +
                                  (cursor_y * CHAR_HEIGHT + py) * fb->pitch +
                                  cursor_x * CHAR_WIDTH * 4);
    for (uint32_t px = 0; px < CHAR_WIDTH; px++) {
      dest[px] = BG_COLOR;
    }
  }
}

void console_set_cursor_visible(int visible) {
  uint32_t color = visible ? 0xFFFFFFFF : 0;
  // Overwrite the character position with a solid block or empty
  for (uint32_t py = 0; py < CHAR_HEIGHT; py++) {
    uint32_t *dest = (uint32_t *)((uint8_t *)fb->address +
                                  (cursor_y * CHAR_HEIGHT + py) * fb->pitch +
                                  cursor_x * CHAR_WIDTH * 4);
    for (uint32_t px = 0; px < CHAR_WIDTH; px++) {
      dest[px] = color;
    }
  }
}

uint32_t console_get_cursor_x(void) { return cursor_x; }

uint32_t console_get_cursor_y(void) { return cursor_y; }

void console_set_cursor(uint32_t x, uint32_t y) {
  if (fb == NULL)
    return;
  if (x >= console_width)
    x = console_width - 1;
  if (y >= console_height)
    y = console_height - 1;
  cursor_x = x;
  cursor_y = y;
}
