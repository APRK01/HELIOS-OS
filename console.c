#include "console.h"

const uint8_t font_8x16[95][16] = {

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x18, 0x3C, 0x3C, 0x3C, 0x18, 0x18, 0x18, 0x00, 0x18, 0x18,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x63, 0x63, 0x63, 0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x36, 0x36, 0x7F, 0x36, 0x36, 0x36, 0x7F, 0x36, 0x36,
     0x00, 0x00, 0x00, 0x00},

    {0x0C, 0x0C, 0x3E, 0x63, 0x61, 0x60, 0x3E, 0x03, 0x03, 0x43, 0x63, 0x3E,
     0x0C, 0x0C, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x61, 0x63, 0x06, 0x0C, 0x18, 0x33, 0x63,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x1C, 0x36, 0x36, 0x1C, 0x3B, 0x6E, 0x66, 0x66, 0x3B,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x30, 0x30, 0x30, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x0C, 0x18, 0x18, 0x30, 0x30, 0x30, 0x30, 0x18, 0x18, 0x0C,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x30, 0x18, 0x18, 0x0C, 0x0C, 0x0C, 0x0C, 0x18, 0x18, 0x30,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x36, 0x1C, 0x7F, 0x1C, 0x36, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x18,
     0x30, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x40,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x3E, 0x63, 0x63, 0x63, 0x6B, 0x6B, 0x63, 0x63, 0x63, 0x3E,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x0C, 0x1C, 0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3F,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x3E, 0x63, 0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x63, 0x7F,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x3E, 0x63, 0x03, 0x03, 0x1E, 0x03, 0x03, 0x03, 0x63, 0x3E,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x06, 0x0E, 0x1E, 0x36, 0x66, 0x7F, 0x06, 0x06, 0x06, 0x0F,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x7F, 0x60, 0x60, 0x60, 0x7E, 0x03, 0x03, 0x03, 0x63, 0x3E,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x1C, 0x30, 0x60, 0x60, 0x7E, 0x63, 0x63, 0x63, 0x63, 0x3E,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x7F, 0x63, 0x03, 0x06, 0x06, 0x0C, 0x0C, 0x18, 0x18, 0x18,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x3E, 0x63, 0x63, 0x63, 0x3E, 0x63, 0x63, 0x63, 0x63, 0x3E,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x3E, 0x63, 0x63, 0x63, 0x3F, 0x03, 0x03, 0x03, 0x06, 0x3C,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x18, 0x18, 0x30,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x30, 0x18, 0x0C, 0x06,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x7E, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x0C, 0x18, 0x30, 0x60,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x3E, 0x63, 0x63, 0x06, 0x0C, 0x0C, 0x0C, 0x00, 0x0C, 0x0C,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x3E, 0x63, 0x63, 0x6F, 0x6B, 0x6F, 0x60, 0x60, 0x3E,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x08, 0x1C, 0x36, 0x63, 0x63, 0x7F, 0x63, 0x63, 0x63, 0x63,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x7E, 0x33, 0x33, 0x33, 0x3E, 0x33, 0x33, 0x33, 0x33, 0x7E,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x1E, 0x33, 0x61, 0x60, 0x60, 0x60, 0x60, 0x61, 0x33, 0x1E,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x7C, 0x36, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x36, 0x7C,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x7F, 0x33, 0x31, 0x34, 0x3C, 0x34, 0x30, 0x31, 0x33, 0x7F,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x7F, 0x33, 0x31, 0x34, 0x3C, 0x34, 0x30, 0x30, 0x30, 0x78,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x1E, 0x33, 0x61, 0x60, 0x60, 0x6F, 0x63, 0x63, 0x37, 0x1D,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x63, 0x63, 0x63, 0x63, 0x7F, 0x63, 0x63, 0x63, 0x63, 0x63,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x0F, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x66, 0x66, 0x3C,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x73, 0x33, 0x36, 0x36, 0x3C, 0x36, 0x36, 0x33, 0x33, 0x73,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x78, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x31, 0x33, 0x7F,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x63, 0x77, 0x7F, 0x7F, 0x6B, 0x63, 0x63, 0x63, 0x63, 0x63,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x63, 0x63, 0x73, 0x7B, 0x7F, 0x6F, 0x67, 0x63, 0x63, 0x63,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x1C, 0x36, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x36, 0x1C,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x7E, 0x33, 0x33, 0x33, 0x3E, 0x30, 0x30, 0x30, 0x30, 0x78,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x1C, 0x36, 0x63, 0x63, 0x63, 0x63, 0x63, 0x6B, 0x36, 0x1C,
     0x06, 0x07, 0x00, 0x00},

    {0x00, 0x00, 0x7E, 0x33, 0x33, 0x33, 0x3E, 0x36, 0x36, 0x33, 0x33, 0x73,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x3E, 0x63, 0x63, 0x30, 0x1C, 0x06, 0x03, 0x63, 0x63, 0x3E,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x7E, 0x5A, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x3E,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x36, 0x1C, 0x08,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x63, 0x63, 0x63, 0x63, 0x6B, 0x6B, 0x6B, 0x7F, 0x36, 0x36,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x63, 0x63, 0x36, 0x1C, 0x1C, 0x1C, 0x36, 0x63, 0x63, 0x63,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x18, 0x18, 0x18, 0x3C,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x7F, 0x63, 0x46, 0x0C, 0x18, 0x30, 0x60, 0x61, 0x63, 0x7F,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x3C, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3C,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x40, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x03, 0x01, 0x00,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3C,
     0x00, 0x00, 0x00, 0x00},

    {0x08, 0x1C, 0x36, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0xFF, 0x00, 0x00, 0x00},

    {0x00, 0x18, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x46, 0x06, 0x3E, 0x66, 0x66, 0x3B,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x70, 0x30, 0x30, 0x3E, 0x33, 0x33, 0x33, 0x33, 0x33, 0x6E,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x3E, 0x63, 0x60, 0x60, 0x60, 0x63, 0x3E,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x0E, 0x06, 0x06, 0x3E, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3B,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x3E, 0x63, 0x7F, 0x60, 0x60, 0x63, 0x3E,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x1C, 0x36, 0x32, 0x30, 0x7C, 0x30, 0x30, 0x30, 0x30, 0x78,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x3B, 0x66, 0x66, 0x66, 0x66, 0x3E, 0x06,
     0x66, 0x3C, 0x00, 0x00},

    {0x00, 0x00, 0x70, 0x30, 0x30, 0x36, 0x3B, 0x33, 0x33, 0x33, 0x33, 0x73,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x0C, 0x0C, 0x00, 0x1C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x1E,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x06, 0x06, 0x00, 0x0E, 0x06, 0x06, 0x06, 0x06, 0x06, 0x66,
     0x66, 0x3C, 0x00, 0x00},

    {0x00, 0x00, 0x70, 0x30, 0x30, 0x33, 0x33, 0x36, 0x3C, 0x36, 0x33, 0x73,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x1C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x1E,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x6E, 0x7F, 0x6B, 0x6B, 0x6B, 0x6B, 0x6B,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x6E, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x3E, 0x63, 0x63, 0x63, 0x63, 0x63, 0x3E,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x6E, 0x33, 0x33, 0x33, 0x33, 0x3E, 0x30,
     0x30, 0x78, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x3B, 0x66, 0x66, 0x66, 0x66, 0x3E, 0x06,
     0x06, 0x0F, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x6E, 0x3B, 0x33, 0x30, 0x30, 0x30, 0x78,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x3E, 0x63, 0x38, 0x0E, 0x03, 0x63, 0x3E,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x08, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x18, 0x18, 0x1B, 0x0E,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3B,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0x63, 0x63, 0x63, 0x36, 0x1C, 0x08,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0x63, 0x6B, 0x6B, 0x6B, 0x7F, 0x36,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0x36, 0x1C, 0x1C, 0x1C, 0x36, 0x63,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0x63, 0x63, 0x63, 0x63, 0x3F, 0x03,
     0x06, 0x3C, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x7F, 0x66, 0x0C, 0x18, 0x30, 0x63, 0x7F,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x0E, 0x18, 0x18, 0x18, 0x70, 0x18, 0x18, 0x18, 0x18, 0x0E,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x18, 0x18, 0x18,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x70, 0x18, 0x18, 0x18, 0x0E, 0x18, 0x18, 0x18, 0x18, 0x70,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x3B, 0x6E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00},
};

static const uint8_t custom_glyphs[8][16] = {
    {0},

    {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
     0xFF, 0xFF, 0xFF, 0xFF},

    {0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
     0x36, 0x36, 0x36, 0x36},

    {0x00, 0x00, 0x00, 0x3E, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
     0x36, 0x36, 0x36, 0x36},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33,
     0x33, 0x33, 0x33, 0x33},

    {0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x63, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00},

    {0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x3F, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33,
     0x33, 0x33, 0x33, 0x33},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00}};

static uint32_t cursor_x = 0;
static uint32_t cursor_y = 0;
static uint32_t console_width = 0;
static uint32_t console_height = 0;
static struct limine_framebuffer *fb = NULL;
static uint32_t current_fg_color = 0xFFFFFF;

#define CHAR_WIDTH 8
#define CHAR_HEIGHT 16
#define BG_COLOR 0x000000

void put_pixel(uint32_t x, uint32_t y, uint32_t color) {
  if (fb == NULL || x >= fb->width || y >= fb->height)
    return;
  volatile uint32_t *pixel =
      (volatile uint32_t *)((uint8_t *)fb->address + y * fb->pitch + x * 4);
  *pixel = color;
}

static void draw_char(uint32_t x, uint32_t y, char c, uint32_t fg_color,
                      uint32_t bg_color) {
  const uint8_t *glyph;
  if (c >= 1 && c <= 7) {
    glyph = custom_glyphs[(int)c];
  } else if (c < 32 || c > 126) {
    c = ' ';
    glyph = font_8x16[0];
  } else {
    glyph = font_8x16[c - 32];
  }

  for (int row = 0; row < CHAR_HEIGHT; row++) {
    uint8_t bits = glyph[row];
    for (int col = 0; col < CHAR_WIDTH; col++) {
      uint32_t color = (bits & (0x80 >> col)) ? fg_color : bg_color;
      put_pixel(x + col, y + row, color);
    }
  }
}

void console_init(struct limine_framebuffer *framebuffer) {
  fb = framebuffer;
  cursor_x = 0;
  cursor_y = 0;
  console_width = fb->width / CHAR_WIDTH;
  console_height = fb->height / CHAR_HEIGHT;
  current_fg_color = 0xFFFFFF;
  console_clear();
}

void console_putchar(char c) {
  if (fb == NULL)
    return;

  if (c == '\n') {
    cursor_x = 0;
    cursor_y++;
  } else if (c == '\r') {
    cursor_x = 0;
  } else if (c == '\b') {
    console_backspace();
  } else {
    draw_char(cursor_x * CHAR_WIDTH, cursor_y * CHAR_HEIGHT, c,
              current_fg_color, BG_COLOR);
    cursor_x++;
  }

  if (cursor_x >= console_width) {
    cursor_x = 0;
    cursor_y++;
  }

  if (cursor_y >= console_height) {

    uint32_t *buffer = (uint32_t *)fb->address;
    uint64_t pitch_pixels = fb->pitch / 4;

    for (uint64_t y = 0; y < (console_height - 1) * CHAR_HEIGHT; y++) {
      for (uint64_t x = 0; x < fb->width; x++) {
        buffer[y * pitch_pixels + x] =
            buffer[(y + CHAR_HEIGHT) * pitch_pixels + x];
      }
    }

    for (uint64_t y = (console_height - 1) * CHAR_HEIGHT; y < fb->height; y++) {
      for (uint64_t x = 0; x < fb->width; x++) {
        buffer[y * pitch_pixels + x] = BG_COLOR;
      }
    }

    cursor_y--;
  }
}

static uint32_t ansi_to_color(int code) {
  switch (code) {
  case 30:
    return 0x000000;
  case 31:
    return 0xFF0000;
  case 32:
    return 0x00FF00;
  case 33:
    return 0xFFFF00;
  case 34:
    return 0x0D00A4;
  case 35:
    return 0xFF00FF;
  case 36:
    return 0x00FFFF;
  case 37:
    return 0xFFFFFF;
  case 90:
    return 0x555555;
  case 91:
    return 0xFF5555;
  case 92:
    return 0x55FF55;
  case 93:
    return 0xFFFF55;
  case 94:
    return 0x5555FF;
  case 95:
    return 0xFF55FF;
  case 96:
    return 0x55FFFF;
  case 97:
    return 0xFFFFFF;
  default:
    return 0xFFFFFF;
  }
}

void console_print(const char *str) {
  while (*str) {

    if (*str == '\033') {
      str++;
      if (*str == '[') {
        str++;

        int code = 0;
        while (*str >= '0' && *str <= '9') {
          code = code * 10 + (*str - '0');
          str++;
        }
        if (*str == 'm') {
          if (code == 0)
            current_fg_color = 0xFFFFFF;
          else
            current_fg_color = ansi_to_color(code);
          str++;
        } else if (*str == ';') {

          while (*str && *str != 'm')
            str++;
          if (*str == 'm')
            str++;
        }
      }
      continue;
    }
    console_putchar(*str++);
  }
}

void console_print_hex(uint64_t n) {
  char hex[] = "0123456789ABCDEF";
  console_print("0x");
  for (int i = 60; i >= 0; i -= 4) {
    console_putchar(hex[(n >> i) & 0xF]);
  }
}

void console_print_dec(uint64_t n) {
  if (n == 0) {
    console_putchar('0');
    return;
  }
  char buf[20];
  int i = 0;
  while (n > 0) {
    buf[i++] = (n % 10) + '0';
    n /= 10;
  }
  while (i > 0) {
    console_putchar(buf[--i]);
  }
}

void console_clear(void) {
  if (fb == NULL)
    return;

  for (uint32_t y = 0; y < fb->height; y++) {
    for (uint32_t x = 0; x < fb->width; x++) {
      put_pixel(x, y, BG_COLOR);
    }
  }
  cursor_x = 0;
  cursor_y = 0;
}

void console_backspace(void) {
  if (cursor_x > 0) {
    cursor_x -= 1;
  } else if (cursor_y > 0) {
    cursor_y -= 1;
    cursor_x = console_width - 1;
  }

  for (uint32_t py = 0; py < CHAR_HEIGHT; py++) {
    uint32_t *dest = (uint32_t *)((uint8_t *)fb->address +
                                  (cursor_y * CHAR_HEIGHT + py) * fb->pitch +
                                  cursor_x * CHAR_WIDTH * 4);
    for (uint32_t px = 0; px < CHAR_WIDTH; px++) {
      dest[px] = BG_COLOR;
    }
  }
}

void console_set_cursor_visible(int visible) {
  uint32_t color = visible ? 0xFFFFFFFF : 0;

  for (uint32_t py = 0; py < CHAR_HEIGHT; py++) {
    uint32_t *dest = (uint32_t *)((uint8_t *)fb->address +
                                  (cursor_y * CHAR_HEIGHT + py) * fb->pitch +
                                  cursor_x * CHAR_WIDTH * 4);
    for (uint32_t px = 0; px < CHAR_WIDTH; px++) {
      dest[px] = color;
    }
  }
}

uint32_t console_get_cursor_x(void) { return cursor_x; }

uint32_t console_get_cursor_y(void) { return cursor_y; }

void console_set_cursor(uint32_t x, uint32_t y) {
  if (fb == NULL)
    return;
  if (x >= console_width)
    x = console_width - 1;

  if (y >= console_height)
    y = console_height - 1;
  cursor_x = x;
  cursor_y = y;
}

uint32_t console_get_width(void) { return console_width; }
uint32_t console_get_height(void) { return console_height; }

static uint32_t cursor_save[16][16];
static int cursor_saved_x = -1, cursor_saved_y = -1;

static const uint8_t cursor_bitmap[16][16] = {
    {1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {1, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {1, 2, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {1, 2, 2, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {1, 2, 2, 2, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {1, 2, 2, 2, 2, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {1, 2, 2, 2, 2, 2, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0},
    {1, 2, 2, 2, 2, 2, 2, 2, 1, 0, 0, 0, 0, 0, 0, 0},
    {1, 2, 2, 2, 2, 2, 2, 2, 2, 1, 0, 0, 0, 0, 0, 0},
    {1, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0},
    {1, 2, 2, 2, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {1, 2, 2, 1, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {1, 2, 1, 0, 1, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0},
    {1, 1, 0, 0, 0, 1, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0},
    {1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0},
};

static inline uint32_t get_pixel(uint32_t x, uint32_t y) {
  if (fb == NULL || x >= fb->width || y >= fb->height)
    return 0;
  volatile uint32_t *pixel =
      (volatile uint32_t *)((uint8_t *)fb->address + y * fb->pitch + x * 4);
  return *pixel;
}

void console_draw_cursor(int x, int y) {
  if (fb == NULL)
    return;
  if (cursor_saved_x >= 0) {
    for (int cy = 0; cy < 16; cy++) {
      for (int cx = 0; cx < 16; cx++) {
        uint32_t px = cursor_saved_x + cx;
        uint32_t py = cursor_saved_y + cy;
        if (px < fb->width && py < fb->height) {
          put_pixel(px, py, cursor_save[cy][cx]);
        }
      }
    }
  }
  cursor_saved_x = x;
  cursor_saved_y = y;
  for (int cy = 0; cy < 16; cy++) {
    for (int cx = 0; cx < 16; cx++) {
      uint32_t px = x + cx;
      uint32_t py = y + cy;
      if (px < fb->width && py < fb->height) {
        cursor_save[cy][cx] = get_pixel(px, py);
        uint8_t v = cursor_bitmap[cy][cx];
        if (v == 1)
          put_pixel(px, py, 0x000000);
        else if (v == 2)
          put_pixel(px, py, 0xFFFFFF);
      }
    }
  }
}

uint32_t console_get_fb_width(void) { return fb ? fb->width : 0; }
uint32_t console_get_fb_height(void) { return fb ? fb->height : 0; }
